# 8.9.1 — Minuscule Force in Kernel Implementations

This note captures the investigation and an actionable debug plan for “particles barely move” in kernel-based Quadrupole and Spectral methods.

## Context
- Repro on http://localhost:8956/index.html with 50k particles.
- Monopole shows healthy motion. Quadrupole appears to run but forces are effectively zero. Spectral runs but default gravity is too small after pipeline scaling.

## Evidence from browser probes
- Quadrupole
  - Force texture is all zeros (meanForce 0, maxForce 0) even after large G (3e-4).
  - Aggregator L0 outA0 texture (packed grid 512×512 for 64³, 8 slices/row) has only 4 non‑zero floats total ⇒ one texel updated.
  - WebGL extensions present: EXT_color_buffer_float, EXT_float_blend.
- Spectral
  - With default randomized gravityStrength (~5e‑7), velocity deltas over several steps are ~1e‑9 ⇒ visually static.
  - When G is raised to 3e‑4 and KPoisson’s constant updated (4πG), mean velocity delta jumps to ~1e‑2 over 5 steps ⇒ healthy.

---

## Track A — Quadrupole: zero force from empty octree
Goal: make L0 aggregation populate the 3D grid so traversal produces non‑zero forces.

1) Verify aggregator pass target and viewport
- Expected L0 pack size: width = gridSize × slicesPerRow; height = gridSize × ceil(gridSize/slicesPerRow).
- Ensure the aggregator’s framebuffer and MRT draw buffers are bound and complete.
- Set gl.viewport to the L0 pack size before drawing; do not inherit particle texture size.
- Temporary litmus test: replace aggregator fragment with a solid write to outA0 to confirm full‑frame coverage.

2) Validate world→voxel mapping
- Reconfirm the index math in the aggregator shader: map worldBounds to [0, gridSize) for x/y/z, then pack z into 2D tiles (slicesPerRow, sliceRows).
- Clamp to valid texel range; ensure flooring/rounding matches CIC/NGP expectations.
- For initial isolation, fix worldBounds to demo bounds to rule out escaped coordinates.

3) Blending/accumulation sanity
- With EXT_float_blend available, verify additive blend state is active for MRT 0..2.
- Clear all MRT attachments before draw; avoid relying on undefined FBO contents.
- Toggle a no‑blend additive fallback path to ensure at least one texel increments when particles land.

4) Pyramid and traversal wiring
- After L0 is populated, run KPyramidBuild for L1.. and read outA0 for L1 to see a non‑zero field.
- Read traversal outForce (or integrator inForce) and confirm meanForce > 0.

Success criteria
- L0 outA0 contains many non‑zero texels (not just one).
- Traversal outForce mean > 0 at default G; velocity meanΔv over 5 steps ≫ 1e‑8.

---

## Track B — Spectral: forces scale too low
Goal: ensure visible motion at demo defaults and keep physically reasonable scaling.

1) Deposit/FFT/Poisson/Gradient checks
- Read back mass grid after KDeposit to confirm non‑zero density.
- Confirm KFFT forward yields non‑zero spectrum samples.
- Ensure KPoisson uses gravitationalConstant = 4πG and updates when gravityStrength changes at runtime.
- Read one inverse force grid (X) to verify magnitude is non‑zero.

2) Force sampling and integration
- Read forceSampleKernel.outForce before integration; compute mean |F|.
- Measure velocity meanΔv over N steps at default G (expect tiny), then with a floor G (see below) to confirm responsiveness.

3) Demo‑level scaling tweak
- Introduce a per‑method gravityStrength floor or multiplier for ‘spectral’ (e.g., G ≥ 1e‑4 .. 3e‑4 in the demo only) so mass‑to‑density and Gaussian smoothing don’t wash out motion.
- Optionally expose a per‑method G control in the UI.

Success criteria
- At the chosen G floor, meanΔv over 5 steps is in ~1e‑3 .. 1e‑2 range and motion is clearly visible.

---

## Instrumentation to add (temporary, minimal)
- In Quadrupole aggregator run():
  - Console asserts for framebuffer completeness and explicit viewport dimensions.
  - One‑frame probe that writes a constant to outA0 to validate coverage, then restore.
- Small readback helpers (already used in the demo harness) to sample:
  - Aggregator outA0, pyramid outA0(L1), traversal outForce, integrator inForce.

## Implementation sketch (low‑risk edits)
- KAggregatorQuadrupole
  - Set gl.viewport to (gridSize×slicesPerRow, gridSize×sliceRows) for the bound FBO.
  - Verify gl.drawBuffers targets and MRT attachment completeness.
  - Ensure blend state (additive) is enabled for accumulation; clear attachments before draw.
- Demo (demo.js)
  - If method === 'spectral', apply a gravityStrength floor or multiplier, and propagate to KPoisson each recreate.
  - Optional: add a Diagnostics toggle to run the probes and print meanForce/meanΔv.

## Risks and mitigations
- Changing viewport could affect other kernels sharing state — mitigate by setting viewport locally around aggregator draw only.
- Demo‑only G scaling: keep it UI‑scoped, do not change library defaults.

## Exit checklist
- Quadrupole
  - [ ] L0 non‑zero coverage verified
  - [ ] Traversal meanForce > 0
  - [ ] meanΔv (5 steps) increases by ≥ 10³× vs. current
- Spectral
  - [ ] Poisson constant updates with G
  - [ ] At demo floor G, motion visibly responsive

## Notes
- Device provides EXT_color_buffer_float and EXT_float_blend; lack of support is not the culprit.
- The “stuck” Quadrupole behavior matches an empty tree: aggregator writes only a single texel, pyramid/traversal see effectively no mass, resulting in zero forces.

## Progress Log

- 2025-10-29 12:00 – Repro in browser via automation. Switched to Quadrupole, read back aggregator outA0: nonZeroTexels=1 of 262,144 (512×512), nonZeroFloats=4. Force texture mean=0. Indicates tree is empty.
- 2025-10-29 12:05 – Checked aggregator FBO: FRAMEBUFFER_COMPLETE, viewport expected 512×512. Sampled center 2×2 block: all zeros.
- 2025-10-29 12:08 – Read aggregator inBounds texture: min=(+1.0e20,+1.0e20,+1.0e20), max=(−1.0e20,−1.0e20,−1.0e20). These are sentinel values from bounds reduction before first valid run.
- 2025-10-29 12:10 – Inspected KBoundsReduce instance on the Quadrupole system: particleTextureWidth/Height are null; reductionPasses=0. renderCount shows runs occurred but with invalid input sizes.
- 2025-10-29 12:12 – Cross-checked source: GravityQuadrupole constructs KBoundsReduce with option names particleTextureWidth/particleTextureHeight instead of particleTextureWidth/particleTextureHeight.
- 2025-10-29 12:14 – Conclusion for Quadrupole: bounds texture never receives valid min/max; aggregator uses invalid bounds (u_useBoundsTexture=true), mapping all particles to voxel (0,0,0) and producing a single written texel; traversal force = 0.
- 2025-10-29 12:18 – Spectral sanity: at default randomized G≈5e−7, meanΔv over 5 steps ≈2.4e−9 (tiny). After setting gravityStrength=3e−4 and updating KPoisson.gravitationalConstant=4πG, meanΔv ≈2.8e−2 (healthy). Spectral path is fine; scale too low in demo defaults.

## Discoveries

- Quadrupole bounds wiring bug: KBoundsReduce is constructed with wrong option names in GravityQuadrupole (particleTextureWidth/particleTextureHeight). Expected: particleTextureWidth/particleTextureHeight. This leaves bounds texture at sentinel values (+/−1e20), causing aggregator to collapse all particles into a single voxel and zero-out traversal forces.
- Spectral scale: Forces are computed correctly; the demo’s randomized gravityStrength is too small once scaled by mass→density and smoothing. Raising G to ~1e−4–3e−4 yields visible motion.